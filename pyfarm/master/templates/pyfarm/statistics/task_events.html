{% extends "pyfarm/user_interface/layout.html" %}
{% block title %}Task Events {% endblock %}
{% block statistics_nb_class %}active{% endblock %}
{% block additional_styles %}
<link href="{{ url_for('static', filename='css/nv.d3.css') }}" rel="stylesheet">
{% endblock %}
{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/vendor/d3.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/vendor/nv.d3.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/task_events.js') }}" type="text/javascript"></script>
{% endblock %}
{% block content %}
<h1>Task Events</h1>

<form method="GET" action="{{ url_for('task_events_ui') }}" class="form-inline" role="form" style="margin-top: 15px;">
  <div class="btn-group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="jobqueue-dropdown-menu" aria-expanded="true">
      Queue <span class="caret"></span>
    </button>
    <ul class="dropdown-menu dropdown-menu-form" role="menu" aria-labelledby="jobqueue-dropdown-menu">
      <li>
        <label class="checkbox">
          {% if no_queue %}
          <input type="checkbox" name="no_queue" value="true" checked/>
          {% else %}
          <input type="checkbox" name="no_queue" value="true"/>
          {% endif %}
        </label>
      </li>
      {% for jobqueue in jobqueues %}
      <li>
        <nobr>
          <label class="checkbox">
            {% if jobqueue.id in jobqueue_ids %}
            <input type="checkbox" name="queue" value="{{ jobqueue.id }}" checked/>
            {% else %}
            <input type="checkbox" name="queue" value="{{ jobqueue.id }}"/>
            {% endif %}
            {{ jobqueue.path() }}
          </label>
        </nobr>
      </li>
      {% endfor %}
    </ul>
  </div>
  <input type="submit" class="btn" value="Filter">
</form>

<div id="event_chart">
  <svg style="height:800px;">
  </svg>
</div>

<div id="avg_chart">
  <svg style="height:800px;">
  </svg>
</div>

<script>
var new_tasks = {{ tasks_new_json }};
var deleted_tasks = {{ tasks_deleted_json }};
var restarted_tasks = {{ tasks_restarted_json }};
var failed_tasks = {{ tasks_failed_json }};
var done_tasks = {{ tasks_done_json }};

var task_events_data = [
    {
    values: new_tasks,
    key: 'New Tasks'
    },
    {
    values: deleted_tasks,
    key: 'Deleted Tasks'
    },
    {
    values: restarted_tasks,
    key: 'Restarted Tasks'
    },
    {
    values: failed_tasks,
    key: 'Failed Tasks'
    },
    {
    values: done_tasks,
    key: 'Done Tasks'
    }
    ];

d3.select('#event_chart svg').datum(task_events_data);

var avg_queued = {{ avg_queued_json }};
var avg_running = {{ avg_running_json }};
var avg_done = {{ avg_done_json }};
var avg_failed = {{ avg_failed_json }};

var task_avgs_data = [
    {
    values: avg_queued,
    key: 'Queued Tasks'
    },
    {
    values: avg_running,
    key: 'Running Tasks'
    },
    {
    values: avg_done,
    key: 'Done Tasks'
    },
    {
    values: avg_failed,
    key: 'Failed Tasks'
    }
    ];

d3.select('#avg_chart svg').datum(task_avgs_data);
</script>
{% endblock %}
